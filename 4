#include <stdio.h>
#include <stdlib.h>
#include <limits.h>

int pick_shortest(int n, int at[], int rem[], int t) {
    int idx = -1, min = INT_MAX;
    for (int i = 0; i < n; ++i)
        if (at[i] <= t && rem[i] > 0 && rem[i] < min) {
            min = rem[i];
            idx = i;
        }
    return idx;
}

void sjf_preemptive(int n, int at[], int bt[]) {
    int *rem = malloc(n * sizeof(int));
    int *st = malloc(n * sizeof(int));
    int *ct = malloc(n * sizeof(int));
    int *wt = malloc(n * sizeof(int));
    int *tat = malloc(n * sizeof(int));
    int *proc = malloc(n * sizeof(int)); // process ids 1..n

    for (int i = 0; i < n; ++i) { rem[i] = bt[i]; proc[i] = i + 1; st[i] = -1; }

    int completed = 0, t = 0, last = -1;
    // simple Gantt storage (process id or -1 for IDLE) with time points
    int gantt_proc[200], gantt_time[200], gc = 0;

    while (completed < n) {
        int cur = pick_shortest(n, at, rem, t);
        if (cur == -1) { // CPU idle
            if (last != -2) { gantt_proc[gc] = -1; gantt_time[gc++] = t; last = -2; }
            ++t;
            continue;
        }

        if (st[cur] == -1) st[cur] = t;
        if (last != proc[cur]) { gantt_proc[gc] = proc[cur]; gantt_time[gc++] = t; last = proc[cur]; }

        rem[cur]--; ++t;
        if (rem[cur] == 0) {
            completed++;
            ct[cur] = t;
            tat[cur] = ct[cur] - at[cur];
            wt[cur] = tat[cur] - bt[cur];
        }
    }

    gantt_time[gc] = t; // end time

    double awt = 0, atat = 0;
    printf("\nProcess\tAT\tBT\tST\tCT\tWT\tTAT\n");
    for (int i = 0; i < n; ++i) {
        awt += wt[i];
        atat += tat[i];
        printf("P%d\t%d\t%d\t%d\t%d\t%d\t%d\n",
               proc[i], at[i], bt[i], st[i], ct[i], wt[i], tat[i]);
    }
    awt /= n; atat /= n;

    printf("\nGantt Chart:\n");
    for (int i = 0; i < gc; ++i) {
        printf("| %s%d ", (gantt_proc[i] == -1 ? "IDLE " : "P"), (gantt_proc[i] == -1 ? 0 : gantt_proc[i]));
    }
    printf("|\n");
    for (int i = 0; i <= gc; ++i) printf("%-5d", gantt_time[i]);

    printf("\n\nAverage Waiting Time: %.2f\nAverage Turnaround Time: %.2f\n", awt, atat);

    free(rem); free(st); free(ct); free(wt); free(tat); free(proc);
}

int main(void) {
    int n;
    printf("Enter number of processes: ");
    if (scanf("%d", &n) != 1 || n <= 0) return 0;

    int *at = malloc(n * sizeof(int)), *bt = malloc(n * sizeof(int));
    for (int i = 0; i < n; ++i) {
        printf("Enter Arrival Time for P%d: ", i + 1);
        scanf("%d", &at[i]);
        printf("Enter Burst Time for P%d: ", i + 1);
        scanf("%d", &bt[i]);
    }

    sjf_preemptive(n, at, bt);

    free(at); free(bt);
    return 0;
}
