#include<semaphore.h>
#include<stdio.h>
#include<stdlib.h>
#include<unistd.h>
#include<pthread.h>
sem_t mutex, wrt;
int sharedvar = 99;
pthread_t writer_threads[100], readers[100];
int readercount = 0;
void reader()
{ sem_wait(&mutex);
  readercount++;
  if(readercount==1)
   sem_wait(&wrt);
   sem_post(&mutex);
   printf("\n%d reader is reading sharedvar=%d", readercount, sharedvar);
   printf("\nReader is done");
    sem_wait(&mutex);
   readercount--;
   if(readercount==0)
    sem_post(&wrt);
    sem_post(&mutex);
  }
  
void writer()
  {
    printf("\nWriter is trying to enter");
    sem_wait(&wrt);
    printf("\nwriter has entered CS");
    sharedvar++;
    printf("\nWriter changed the value of the shared var to %d", sharedvar);
    sem_post(&wrt);
    printf("\nWriter is out of CS");
    }
    
int main() {
    int i,n2;
    printf("Enter the number of readers & writers:");
    scanf("%d",&n2);

    sem_init(&mutex, 0, 1);
    sem_init(&wrt, 0, 1);

    for (i = 0; i < n2; i++) {
        pthread_create(&readers[i], NULL, (void*)reader, NULL);
        pthread_create(&writer_threads[i],NULL,(void*)writer,NULL);
    }

    for (i = 0; i < n2; i++) {
        pthread_join(readers[i], NULL); 
        pthread_join(writer_threads[i], NULL);
    }

    sem_destroy(&mutex);
    sem_destroy(&wrt);

    return 0;
}

